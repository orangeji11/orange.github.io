# 环境准备
## 安装管道
在operatorhub安装有雀管道组件
## 安装gitlab
1. operatorhub添加源redhat-operators
```yaml
apiVersion: "operators.coreos.com/v1alpha1"
kind: "CatalogSource"
metadata:
  name: "redhat-operators"
  namespace: "openshift-marketplace"
  annotations:
    target.workload.openshift.io/management: '{"effect": "PreferredDuringScheduling"}'
spec:
  sourceType: grpc
  image: registry.redhat.io/redhat/redhat-operator-index:v4.10
  displayName: "Red Hat Operators"
  publisher: "Red Hat"
  priority: -100
  updateStrategy:
    registryPoll:
      interval: 10m
  grpcPodConfig:
    nodeSelector:
        node-role.kubernetes.io/master: ""
        kubernetes.io/os: "linux"
    priorityClassName: "system-cluster-critical"
    tolerations:
    - key: "node-role.kubernetes.io/master"
      operator: Exists
      effect: "NoSchedule"
    - key: "node.kubernetes.io/unreachable"
      operator: "Exists"
      effect: "NoExecute"
      tolerationSeconds: 120
    - key: "node.kubernetes.io/not-ready"
      operator: "Exists"
      effect: "NoExecute"
      tolerationSeconds: 120
```
2. operatorhub中安装cert-manager组件
3. 添加operatorhub并在operatorhub中安装gitlab组件  
```yaml
apiVersion: "operators.coreos.com/v1alpha1"
kind: "CatalogSource"
metadata:
  name: "community-operators"
  namespace: "openshift-marketplace"
  annotations:
    target.workload.openshift.io/management: '{"effect": "PreferredDuringScheduling"}'
spec:
  sourceType: grpc
  image: registry.redhat.io/redhat/community-operator-index:v4.10
  displayName: "Community Operators"
  publisher: "Red Hat"
  priority: -400
  updateStrategy:
    registryPoll:
      interval: 10m
  grpcPodConfig:
    nodeSelector:
        node-role.kubernetes.io/master: ""
        kubernetes.io/os: "linux"
    priorityClassName: "system-cluster-critical"
    tolerations:
    - key: "node-role.kubernetes.io/master"
      operator: Exists
      effect: "NoSchedule"
    - key: "node.kubernetes.io/unreachable"
      operator: "Exists"
      effect: "NoExecute"
      tolerationSeconds: 120
    - key: "node.kubernetes.io/not-ready"
      operator: "Exists"
      effect: "NoExecute"
      tolerationSeconds: 120
```
使用镜像代理：
  + gcr.io –> gcr.lank8s.cn
  + k8s.gcr.io –> lank8s.cn\
修改gitlab组件manifests
gcr.io/kubebuilder/kube-rbac-proxy => gcr.lank8s.cn/kubebuilder/kube-rbac-proxy

4. 等待安装完成后创建gitlab项目
```yaml
apiVersion: apps.gitlab.com/v1beta1
kind: GitLab
metadata:
  name: gitlab
  namespace: gitlab-system
spec:
  chart:
    values:
      certmanager:
        install: false
      nginx-ingress:
        install: false
      global:
        hosts:
          domain: apps.uccps-rc9.jzy.com
          hostSuffix: null
        ingress:
          configureCertmanager: false
          tls:
            secretName: null
          class: none
          annotations:
            route.openshift.io/termination: "edge"
    version: 6.8.3
```
5. 创建路由并访问  
oc expose svc gitlab-webservice-default -n gitlab-system
http://gitlab-webservice-default-gitlab-system.apps.uccps-rc9.jzy.com/users/sign_in
密码在secret gitlab-gitlab-initial-root-password 中保存